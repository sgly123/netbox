# Docker Composeæ–‡ä»¶ - åŒæœåŠ¡æ¶æ„ + å¼€å‘è€…æ¨¡å¼
# ä½¿ç”¨æ–¹æ³•:
#   ç”Ÿäº§æ¨¡å¼: docker-compose up -d
#   å¼€å‘æ¨¡å¼: docker-compose --profile dev up -d
#   æˆ–è®¾ç½®ç¯å¢ƒå˜é‡: NETBOX_MODE=dev docker-compose up -d

services:
  # EchoæœåŠ¡å™¨ - ç”Ÿäº§æ¨¡å¼
  netbox-echo:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile}
    container_name: netbox-echo-server
    restart: unless-stopped
    ports:
      - "8888:8888"  # EchoæœåŠ¡å™¨ç«¯å£
    volumes:
      # ç”Ÿäº§æ¨¡å¼ï¼šåªæŒ‚è½½é…ç½®å’Œæ—¥å¿—
      - ./config:/app/config:ro  # é…ç½®æ–‡ä»¶æŒ‚è½½ï¼ˆåªè¯»ï¼‰
      - ./logs:/app/logs         # æ—¥å¿—ç›®å½•æŒ‚è½½
      - ./data:/app/data         # æ•°æ®ç›®å½•æŒ‚è½½
      # å¼€å‘æ¨¡å¼ï¼šé¢å¤–æŒ‚è½½æºç ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
      - ${SOURCE_MOUNT:-/dev/null}:/workspace
    environment:
      - TZ=Asia/Shanghai
      - NETBOX_MODE=${NETBOX_MODE:-production}
    networks:
      - netbox-network
    command: ["./NetBox", "config/config-echo.yaml"]
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "NetBox"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production
      - ""  # é»˜è®¤profile

  # RedisæœåŠ¡å™¨ - ç”Ÿäº§æ¨¡å¼
  netbox-redis:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile}
    container_name: netbox-redis-server
    restart: unless-stopped
    ports:
      - "6380:6379"  # Redisåè®®ç«¯å£
    volumes:
      # ç”Ÿäº§æ¨¡å¼ï¼šåªæŒ‚è½½é…ç½®å’Œæ—¥å¿—
      - ./config:/app/config:ro  # é…ç½®æ–‡ä»¶æŒ‚è½½ï¼ˆåªè¯»ï¼‰
      - ./logs:/app/logs         # æ—¥å¿—ç›®å½•æŒ‚è½½
      - ./data:/app/data         # æ•°æ®ç›®å½•æŒ‚è½½
      # å¼€å‘æ¨¡å¼ï¼šé¢å¤–æŒ‚è½½æºç ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
      - ${SOURCE_MOUNT:-/dev/null}:/workspace
    environment:
      - TZ=Asia/Shanghai
      - NETBOX_MODE=${NETBOX_MODE:-production}
    networks:
      - netbox-network
    command: ["./NetBox", "config/config-redis.yaml"]
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "NetBox"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production
      - ""  # é»˜è®¤profile

  # WebSocketæœåŠ¡å™¨ - ç”Ÿäº§æ¨¡å¼
  netbox-websocket:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile}
    container_name: netbox-websocket-server
    restart: unless-stopped
    ports:
      - "8001:8001"  # WebSocketæœåŠ¡å™¨ç«¯å£
    volumes:
      # ç”Ÿäº§æ¨¡å¼ï¼šåªæŒ‚è½½é…ç½®å’Œæ—¥å¿—
      - ./config:/app/config:ro  # é…ç½®æ–‡ä»¶æŒ‚è½½ï¼ˆåªè¯»ï¼‰
      - ./logs:/app/logs         # æ—¥å¿—ç›®å½•æŒ‚è½½
      - ./data:/app/data         # æ•°æ®ç›®å½•æŒ‚è½½
      # å¼€å‘æ¨¡å¼ï¼šé¢å¤–æŒ‚è½½æºç ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
      - ${SOURCE_MOUNT:-/dev/null}:/workspace
    environment:
      - TZ=Asia/Shanghai
      - NETBOX_MODE=${NETBOX_MODE:-production}
    networks:
      - netbox-network
    command: ["./NetBox", "config/config-websocket.yaml"]
    # èµ„æºé™åˆ¶ï¼ˆæ”¯æŒ2000å¹¶å‘ï¼‰
    deploy:
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "NetBox"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production
      - ""  # é»˜è®¤profile

  # å¼€å‘æ¨¡å¼ - ç»Ÿä¸€å¼€å‘å®¹å™¨
  netbox-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: netbox-dev-server
    restart: unless-stopped
    ports:
      - "6379:6379"  # Redisåè®®ç«¯å£
      - "8888:8888"  # EchoæœåŠ¡å™¨ç«¯å£
      - "8001:8001"  # WebSocketæœåŠ¡å™¨ç«¯å£
      - "9999:9999"  # è°ƒè¯•ç«¯å£
    volumes:
      # å¼€å‘æ¨¡å¼ï¼šæºç å®æ—¶æŒ‚è½½
      - .:/workspace:rw                    # æ•´ä¸ªé¡¹ç›®æºç ï¼ˆå¯è¯»å†™ï¼‰
      - ./config:/app/config:ro            # é…ç½®æ–‡ä»¶
      - ./logs:/app/logs                   # æ—¥å¿—ç›®å½•
      - ./data:/app/data                   # æ•°æ®ç›®å½•
      - build-cache:/workspace/build       # æ„å»ºç¼“å­˜æŒä¹…åŒ–
    environment:
      - TZ=Asia/Shanghai
      - NETBOX_MODE=development
      - DEBUG=1
      - CC=gcc
      - CXX=g++
    networks:
      - netbox-network
    working_dir: /workspace
    # å¼€å‘æ¨¡å¼å¯åŠ¨è„šæœ¬
    command: >
      bash -c "
        echo 'ğŸ”§ NetBox å¼€å‘æ¨¡å¼å¯åŠ¨...' &&
        echo 'ğŸ“ æºç å·²æŒ‚è½½åˆ° /workspaceï¼Œæ”¯æŒå®æ—¶ä¿®æ”¹' &&
        echo 'ğŸ”¨ ç¼–è¯‘å‘½ä»¤:' &&
        echo '  cd /workspace' &&
        echo '  mkdir -p build && cd build' &&
        echo '  cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=OFF' &&
        echo '  make -j\$(nproc)' &&
        echo '' &&
        echo 'ğŸš€ å¯åŠ¨å‘½ä»¤:' &&
        echo '  EchoæœåŠ¡: ./build/bin/NetBox config/config-echo.yaml' &&
        echo '  RedisæœåŠ¡: ./build/bin/NetBox config/config-redis.yaml' &&
        echo '  WebSocketæœåŠ¡: ./build/bin/NetBox config/config-websocket.yaml' &&
        echo '' &&
        echo 'ğŸ“ å®¹å™¨ä¿æŒè¿è¡Œï¼Œè¯·æ‰‹åŠ¨è¿›å…¥å®¹å™¨æ“ä½œ:' &&
        echo '  docker exec -it netbox-dev-server bash' &&
        echo '' &&
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD", "test", "-d", "/workspace"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - dev
      - development

networks:
  netbox-network:
    driver: bridge
    name: netbox-network
volumes:
  netbox-logs:
    driver: local
  netbox-data:
    driver: local
  build-cache:
    driver: local
